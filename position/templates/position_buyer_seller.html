{% load i18n %}
{% load static %}
<!DOCTYPE html>
<html>
<head>
    {% include "_header_00.html" %}
    <title>Dashboard</title>
</head>

<body>
    {% include "_menu_group.html" %}
    <div class="container">
        <div class="row row-cols-1 row-cols-md-1 row-cols-lg-2 row-cols-xl-2 g-3">
            <div class="card text-dark bg-light mb-3 shadow">
                <div class="mb-3">
                    <h1><i>{% trans "RPG DASHBOARD" %}</i></h1><h2><span class="txtRole" id="txtRole0"></span><br>{% trans "RPG Round:"%} {{ rpg_closest_round }}<br>{% trans "Product:" %} {{ rpg_current_product_name|safe }}</h2><h4>{% trans "Group:" %} {{ groupDigit }}<br>{% trans "Class:" %} {{ currentClassName }}<br>{% trans "Teacher:"%} {{ currentTeacher }}</h4>
                    <p>
                        <br>{% trans "Deals Begin:" %} {{ rpg_closest_end_date }}
                        <br>{% trans "Deals End:" %} {{ rpg_play_days_left }}
                    </p>
                </div>
            </div> <!-- End Card -->

            <div class="card text-dark bg-light mb-3 shadow">
                <a href="{% url 'home' %}">
                    <div class="card text-light mb-3 shadow text-center position-relative"
                        style="background-image: url({% static 'images/logoClass01_blur.png' %}); 
                            background-size: cover; 
                            background-position: center; 
                            backdrop-filter: blur(100px);">
                
                        <div class="mb-3">
                            <img id="imgRandomImage" alt="A random anime image" style="width: 200px; height: 200px; object-fit: cover;">
                        </div>
                
                        <!-- Overlay text -->
                        <div class="position-absolute bottom-0 start-0 mb-2 ms-2">
                            <span class="bg-dark text-light py-1 px-3" style="border-radius: 5px;">{% trans "GO TO LOGIN PAGE" %}</span>
                        </div>
                    </div>
                </a>
                <a href="{{ request.path }}">
                    <div class="alert alert-warning text-end" role="alert">
                        <h1><i>{% trans "REFRESH TO UPDATE" %}</i></h1>
                    </div>
                </a>
            </div>

            <div class="card custom-card mb-3 shadow">
                <h4 class="card-header custom-card-header">{% trans "Negotiation Position" %} <i>Quick View</i></h4>
                <div class="card-body">
                    <div class="row fw-bold">
                        <div class="col-4">{% trans "RESISTANCE:" %}</div>
                        <div class="col-8"><span id="txtPositionResistance">{{ rpg_resistance }}</span><span id="txtPositionResistanceHelp" class="small text-muted"></span></div>
                        <div class="col-4">{% trans "FLEX:" %}</div>
                        <div class="col-8"><span id="txtPositionFlex">{{ groupFlex }}</span><span id="txtPositionFlexHelp" class="small text-muted"></span></div>
                        <div class="col-4"><span id="txtMaxPurchase">{% trans "MAX Purchase:" %}</span></div>
                        <div class="col-8"><span id="txtPositionMaxPurchase">{{ rpg_max_purchase }}</span><span id="txtPositionMaxPurchaseHelp" class="small text-muted"></span></div>
                        <div class="col-4">{% trans "DELIVERY:" %}</div>
                        <div class="col-8"><span id="txtPositionDelivery">{{ groupDelivery }}</span><span id="txtPositionDeliveryHelp" class="small text-muted"></span></div>
                        <div class="col-4">{% trans "UNITS:" %}</div>
                        <div class="col-8"><span id="txtPositionUnits">{{ rpg_mod_units }}</span><span id="txtPositionUnitsHelp" class="small text-muted"></span></div>
                        <div class="col-4">{% trans "IMPORTANCE:" %}</div>
                        <div class="col-8"><span id="txtPositionImportance">{{ groupImportance }}</span><span id="txtPositionImportanceHelp" class="small text-muted"></span></div>
                        <div class="col-4">{% trans "QUALITY:" %}</div>
                        <div class="col-8"><span id="txtPositionQuality">{{ groupQuality }}</span><span id="txtPositionQualityHelp" class="small text-muted"></span></div>
                        <div class="col-4">{% trans "ROLE:" %}</div>
                        <div class="col-8">[{{ groupRole }}] <span class="txtRole" id="txtRole1">{{ groupRole }}</span></div>
                    </div>

                    <p style="display: none;">{% trans "Notes:" %}<br>
                        <div id="txtGroupNote" onclick="editNote()" style="display: none;"></div>
                    </p>
                    <!-- Not in use at this time -->
                    <div style="display: none" class="text-info" onclick="editNote()">{% trans "(Click to edit note)" %}</div>
                    <!-- Hidden input field for editing -->
                    <textarea id="txtTeacherNoteEdit" style="display: none;"></textarea>
                    <button id="btnSaveNote" style="display: none;" onclick="saveNote()">{% trans "Save" %}</button>
                </div>
            </div> <!-- End Card -->
        

            <div class="card custom-card mb-3 shadow">
                <h4 class="card-header custom-card-header">{% trans "Actions" %}</h4>
                <div class="card-body">
                    <div class="container mt-1">
                        <div id="icoSpinner" class="spinner-border text-secondary" role="status" style="display:none;">
                            <span class="visually-hidden">ROLLING</span>
                        </div>
                        <!-- Buttons to send deal or points or cancel -->
                        <button class="btn btn-primary col-sm-5 text-center mt-3" id="btnSendDeal">{% trans "Send A Deal" %}</button>
                        <button class="btn btn-primary col-sm-5 text-center mt-3" id="btnCancelDeal"> {% trans "Cancel A Deal" %}</button>
                        <button class="btn btn-primary col-sm-5 text-center mt-3" id="btnSendFlex">{% trans "Gift Flex Points" %}</button>
                        <button class="btn btn-primary col-sm-5 text-center mt-3" id="btnSendMessage">{% trans "Message A Group" %}</button>

                        <!-- Adding form for sending DEAL -->
                        <div id="btnOpenDealForm" class="hidden-form mt-3 row align-items-center">
                            <div class="col-12 text-center mb-4">
                                <h1 class="display-7" id="txtOrderTitle">{% trans "PURCHASE/SALE ORDER" %}</h1>
                            </div>
                            <form id="frmDealForm" method="post" action="{% url 'save_deal' %}">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-4">{% trans "Counterpart:" %}</div>
                                    <div class="col-8"><input id="inputCounterparty" type="number" name="counterparty" class="form-control" style="width: 150px;"></div>

                                    <div class="col-4 mt-2">{% trans "Units:" %}</div>
                                    <div class="col-8 mt-2"><input id="inputUnits" type="number" name="units" class="form-control" style="width: 150px;"></div>

                                    <div class="col-4 mt-2">{% trans "Price:" %}</div>
                                    <div class="col-8 mt-2"><input id="inputPrice" type="number" name="price" step="0.01" class="form-control" style="width: 150px;"></div>

                                    <div class="col-4 mt-2">{% trans "Quality:" %}</div>
                                    <div class="col-8 mt-2">
                                        <select id="sltQuality" name="quality" class="form-select"  style="width: 150px;>
                                            {% for value, display_name in formDeal.fields.quality.choices %}
                                                <option value="{{ value }}">{{ display_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-4 mt-2">{% trans "Delivery:" %}</div>
                                    <div class="col-8 mt-2">
                                        <select id="sltDelivery" name="delivery" class="form-select"  style="width: 150px;>
                                            {% for value, display_name in formDeal.fields.delivery.choices %}
                                                <option value="{{ value }}">{{ display_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="row align-items-center">
                                    <div class="col-4">
                                        <button id="btnSubmitDeal" type="submit" class="btn btn-success mt-3">{% trans "Send Deal" %}</button>
                                    </div>
                                    <div class="col-8 mt-3">
                                        {% trans "Deal ID:" %}<input type="number" id="inputDealID" name="dealID" class="form-control" style="width: 175px;"><span id="txtDealID" class="small text-muted">{% trans "Buyer and seller must use SAME Deal ID." %}</span>
                                        <br><span id="newDealID"></span><a href="#" id="txtUseThisID" class="small text-muted"><={% trans "Use this NEW Deal ID." %}</a>
                                    </div>
                                </div>
                            </form>
                        </div> <!-- End dealForm-->

                        <!-- Adding form for CANCEL DEAL -->
                        <div id="btnOpenCancelForm" class="hidden-form mt-3 row align-items-center">
                            <div class="col-12 text-center mb-4">
                                <h1 class="display-7">{% trans "CANCEL PURCHASE ORDER" %}</h1>
                            </div>
                            <form id="frmCancelForm" method="post" action="{% url 'cancel_deal' %}">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-4">{% trans "Counterpart:" %}</div>
                                    <div class="col-8"><input type="number" name="counterpartyCancel" class="form-control" style="width: 75px;"></div>
                                    <div class="col-4">{% trans "Deal ID:" %}</div>
                                    <div class="col-8"><input type="number" id="dealIDCancel" name="dealIDCancel" class="form-control" style="width: 175px;"></div>
                                </div>
                                <div class="row align-items-center">
                                    <div class="col-4">
                                        <button id="btnSubmitCancel" type="submit" class="btn btn-success mt-3">{% trans "Cancel Deal" %}}</button>
                                    </div>
                                </div>
                            </form>
                        </div> <!-- End Cancel Form-->



                        <!-- Adding form for Gifting Flex Points -->
                        <div id="btnOpenSendFlexForm" class="hidden-form mt-3 row align-items-center">
                            <div class="col-12 text-center mb-4">
                                <h1 class="display-7">{% trans "SEND FLEX POINTS" %}</h1>
                            </div>
                            <form id="frmSendFlexForm" method="post" action="{% url 'gift_flex' %}">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-4">{% trans "Send To:" %}</div>
                                    <div class="col-8"><input type="number" name="giftReceiver" class="form-control" style="width: 75px;"></div>
                                    <div class="col-4">{% trans "Flex Points:" %}</div>
                                    <div class="col-8"><input type="number" id="txtGiftAmount" name="giftAmount" class="form-control" style="width: 75px;"></div>
                                    <div class="col-4">{% trans "Message:" %}</div>
                                    <div class="col-8"><textarea id="txtMessageArea" name="giftMessage" rows="4" cols="50" class="form-control"></textarea></div>
                                </div>
                                <div class="row align-items-center">
                                    <div class="col-4">
                                        <button id="btnSubmitGiftFlex" type="submit" class="btn btn-success mt-3">{% trans "Send Flex Points" %}</button>
                                    </div>
                                </div>
                            </form>
                        </div> <!-- End send flex points form -->

                        <!-- Adding form for Messaging other groups -->
                        <div id="btnOpenSendMessageForm" class="hidden-form mt-3 row align-items-center">
                            <div class="col-12 text-center mb-4">
                                <h1 class="display-7">{% trans "SEND MESSAGE" %}</h1>
                            </div>
                            <form id="frmSendMessageForm" method="post" action="{% url 'send_message' %}">
                                {% csrf_token %}
                                <div class="row">
                                    <div class="col-4">{% trans "Send To:" %}</div>
                                    <div class="col-8"><input type="number" name="messageReceiver" class="form-control" style="width: 150px;"></div>
                                    <div class="col-4">{% trans "Message Subject:" %}</div>
                                    <div class="col-8"><input type="text" id="txtMessageSubject" name="messageSubject" class="form-control" style="width: 350px;"></div>
                                    <div class="col-4">{% trans "Message:" %}</div>
                                    <div class="col-8"><textarea name="messageContent" rows="4" cols="50" class="form-control"></textarea></div>
                                </div>
                                <div class="row align-items-center">
                                    <div class="col-4">
                                        <button id="btnSubmitSendMessage" type="submit" class="btn btn-success mt-3">{% trans "Send Message" %}</button>
                                    </div>
                                </div>
                            </form>
                        </div> <!-- End send message Form-->

                    </div> <!-- End of container -->
                </div> <!-- End of card body -->
    
                {% if messages %}
                    <ul class="messages">
                        {% for message in messages %}
                            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}

            </div> <!-- End of card -->

            <div class="card custom-card mb-3 shadow">
                <h4 class="card-header custom-card-header">{% trans "Deals Completed" %}<sup>a</sup></h4>
                <div class="card-body">
                    <table class="table table-hover table-striped table-responsive">
                        <thead class="custom-thead">
                            <tr>
                                <th scope="col" title="Deal Identifier">{% trans "Deal ID" %}</th>
                                <th scope="col" title="Counterpart Group">{% trans "With" %}</th>
                                <th scope="col" title="Number of Units">{% trans "Units" %}</th>
                                <th scope="col" title="Deal Price">{% trans "Price" %}</th>
                                <th scope="col" title="Quality Level">{% trans "Qual." %}</th>
                                <th scope="col" title="Delivery Speed">{% trans "Deliv." %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for deal in final_deals %}
                            <tr>
                                <td>{{ deal.dealDealID }}</td>
                                <td>{% trans "Group" %} {{ deal.dealCounterpart }}</td>
                                <td>{{ deal.dealUnits }}</td>
                                <td>{{ deal.dealPrice }}</td>
                                <td>{{ deal.dealQuality }}</td>
                                <td>{{ deal.dealDelivery }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div> <!-- End card body-->
                <div class="small text-muted"><sup>a</sup>{% trans "Deals waiting for counterparties are not shown here." %}</div>
            </div> <!-- End card -->

            <div class="card custom-card mb-3 shadow">
                <h4 class="card-header custom-card-header">{% trans "Canceled Deals" %}</h4>
                <div class="card-body">
                    <h4 class="card-header">{% trans "Deals Canceled With Penalty" %}</h4>
                    <table class="table table-hover table-striped table-responsive">
                        <thead class="custom-thead">
                            <tr>
                                <th scope="col" title="Deal Identifier">{% trans "Deal ID" %}</th>
                                <th scope="col" title="Canceling Group">{% trans "Canceled By" %}</th>
                                <th scope="col" title="Canceler's Role">{% trans "Counterpart" %}</th>
                                <th scope="col" title="Canceler's Role">{% trans "Role" %}</th>                                
                                <th scope="col" title="Units">{% trans "Units" %}</th>
                                <th scope="col" title="Penalty"><sup>a</sup>{% trans "Penalty" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for deal in penalized_deals %}
                            <tr>
                                <td>{{ deal.dealDealID }}</td>
                                <td>{% trans "Group" %} {{ deal.groupDigit }}</td>
                                <td>{% trans "Group" %} {{ deal.dealCounterpart }}</td>                                
                                <td>{{ deal.dealBuySell }}</td>
                                <td>{{ deal.dealUnits }}</td>
                                <td><i class="fas fa-minus"></i> {{ deal.penalty_amount }} {% trans "Flex Points" %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div> <!--end card body-->
                <div class="card-body">
                    <h4 class="card-header">{% trans "Deals Canceled By Both" %}</h4>
                        <table class="table table-hover table-striped table-responsive">
                            <thead class="custom-thead">
                                <tr>
                                    <th scope="col" title="Deal Identifier">{% trans "Deal ID" %}</th>
                                    <th scope="col" title="Canceling Group">{% trans "Canceled By" %}</th>
                                    <th scope="col" title="Cancelers Role"><sup>b</sup>{% trans "Role" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for deal in mutually_canceled_deals %}
                                <tr>
                                    <td>{{ deal.dealDealID }}</td>
                                    <td>{% trans "Group" %} {{ deal.groupDigit }} & {{ deal.dealCounterpart }}</td>
                                    <td>{{ deal.dealBuySell }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                </div> <!-- End card body-->

                <div class="card-body">
                    <h4 class="card-header">{% trans "Invalid Deals" %}<span class="small text-muted"> {% trans "(Repeated Deal ID)" %}<sup>c</sup></span></h4>
                    {% if repeated_deals %}
                        <table class="table table-hover table-striped table-responsive">
                            <thead class="custom-thead">
                                <tr>
                                    <th scope="col" title="Deal Identifier">{% trans "Deal ID" %}</th>
                                    <th scope="col" title="Canceling Group">{% trans "Sent By" %}</th>
                                    <th scope="col" title="Cancelers Role">{% trans "Counterpart" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for deal in repeated_deals %}
                                <tr>
                                    <td>{{ deal.dealDealID }}</td>
                                    <td>{% trans "Group" %} {{ deal.groupDigit }} </td>
                                    <td>{{ deal.dealCounterpart }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>{% trans "No repeated Deal IDs." %}</p>
                    {% endif %}
                </div> <!-- End card body-->


                <div class="card-body">
                    <h4 class="card-header">{% trans "Invalid Cancels" %}<span class="small text-muted"> {% trans "(Repeated Deal ID)" %}<sup>c</sup></span></h4>
                    {% if repeated_cancels %}
                        <table class="table table-hover table-striped table-responsive">
                            <thead class="custom-thead">
                                <tr>
                                    <th scope="col" title="Deal Identifier">{% trans "Deal ID" %}</th>
                                    <th scope="col" title="Canceling Group">{% trans "Sent By" %}</th>
                                    <th scope="col" title="Cancelers Role">{% trans "Counterpart" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for deal in repeated_cancels %}
                                <tr>
                                    <td>{{ deal.dealDealID }}</td>
                                    <td>{% trans "Group" %} {{ deal.groupDigit }} </td>
                                    <td>{{ deal.dealCounterpart }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %}
                        <p>{% trans "No repeated cancel Deal IDs." %}</p>
                    {% endif %}
                </div> <!-- End card body-->

                <div class="small text-muted"><sup>a</sup>{% trans "Canceling deals costs:" %}</div>
                <div class="small text-muted">A) {% trans "Both parties cancel = NO cost to you & NO cost to counterparty." %}</div>
                <div class="small text-muted">B) {% trans "You cancel but counterparty does NOT cancel = 0.5 Flex Points per 100 units of the deal (minimum fee of 1 rounded down afterward)." %}</div>
                <div class="small text-muted">C) {% trans "You do NOT cancel but counterparty cancels = NO extra cost to you (deal is lost)." %}</div>
                <div class="small text-muted"><sup>b</sup>{% trans "Role 1 = Buyer; -1 = Seller." %}</div>
                <div class="small text-muted"><sup>c</sup>{% trans "Use a DEAL ID only ONCE!" %}</div>
            </div> <!-- End card -->
            
            <div class="card custom-card mb-3 shadow">
                <h4 class="card-header custom-card-header">{% trans "Flex Points:" %} {{ rpgFlexPoints }}</h4>
                <div class="card-body">
                    <table class="table table-hover table-striped table-responsive">
                        <thead class="custom-thead">
                            <tr>
                                <th scope="col" title="Deal Identifier">{% trans "Deal ID" %}</th>
                                <th scope="col" title="Number of Units">{% trans "Units" %}</th>
                                <th scope="col" title="Quality Level"><sup>a</sup>{% trans "Qual. Gap" %}</th>
                                <th scope="col" title="Delivery Gap"><sup>a</sup>{% trans "Deliv. Gap" %}</th>
                                <th scope="col" title="Loss/Gain">{% trans "Loss/Gain" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for deal in final_deals %}
                            <tr>
                                <td>{{ deal.dealDealID }}</td>
                                <td>{{ deal.dealUnits }}</td>
                                <td>{{ deal.deal_quality_gap }}</td>
                                <td>{{ deal.deal_delivery_gap }}</td>
                                <td>{{ deal.deal_flex_points }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                            <th colspan="1"><sup>b</sup>{% trans "Bonus:" %}</th>
                            <td colspan="1"><i class="fas fa-plus"></i>{{ bonus_flex_points }}</td>
                            </tr>
                            <tr id="txtOverProduction">
                                <th colspan="1"><sup>c</sup>{% trans "Over Production:" %}</th>
                                <td colspan="1"><i class="fas fa-minus"></i>{{ overproduction_flex_fee }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div> <!-- End card body-->
                <div id="txtFlexMsg0" class="small text-muted"><sup>a</sup>{% trans "Going higher gains Flex Points (1 point per 100 units--round up)." %}</div>
                <div id="txtFlexMsg1" class="small text-muted">{% trans "Going lower spends Flex Points (1 point per 100 units--round up)." %}</div>
                <div  id="txtFlexMsg2" class="small text-muted">{% trans "Canceling a deal will have a cost if both sides do NOT agree (see Canceled Deals area)." %}</div>
                <br><div id="txtFlexMsg3" class="small text-muted"><sup>b</sup>{% trans "Earn extra Flex Points by making more deals with different groups (at least 10% of target units with different groups)." %}</div>
                <br><div id="txtFlexMsg4" class="small text-muted"><sup>c</sup>{% trans "Production over MAX costs 1 Flex Point for every 10% increase over UNITS." %}</div>
            </div> <!-- End card -->

            <div class="card custom-card custom-card text-dark bg-light mb-3 shadow">
                <h4 class="card-header custom-card-header">{% trans "Weighted Avg. Price" %}</h4>
                <div class="card-body">
                    <table class="table table-bordered table-striped table-responsive">
                        <thead class="custom-thead">
                            <tr>
                            <th scope="col">{% trans "Deal ID" %}</th>
                            <th scope="col">{% trans "Counterpart" %}</th>
                            <th scope="col">{% trans "Price" %}</th>
                            <th scope="col">{% trans "Quantity (Units)" %}</th>
                            <th scope="col">{% trans "Weighted Price" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for deal in final_deals %}
                            <tr>
                            <td>{{ deal.dealDealID }}</td>
                            <td>{% trans "Group" %} {{ deal.dealCounterpart }}</td>
                            <td>{{ deal.dealPrice }}</td>
                            <td>{{ deal.dealUnits }}</td>
                            <td>{{ deal.weighted_price }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                            <th colspan="3">{% trans "Total Units:" %}</th>
                            <td colspan="1">{{ total_units }}</td>
                            </tr>
                            <tr>
                            <th colspan="3">{% trans "Average Weighted Price:" %}</th>
                            <td></td>
                            <td colspan="2">{{ average_weighted }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div> <!-- End card body-->
            </div> <!-- End card -->

            <div class="card custom-card text-dark bg-light mb-3 shadow" id="crdInventory">
                <h4 class="card-header custom-card-header"><div id="txtInventoryTitle">{% trans "Inventory" %}</div></h4>
                <div class="card-body">
                    <table class="table table-striped table-responsive">
                        <thead class="custom-thead">
                            <tr>
                            <th>{% trans "Total" %}</th>
                            <th>{% trans "Target" %}</th>
                            <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                            <td>{{ total_units }}</td>
                            <td>{{ rpg_mod_units }}</td>
                            <td>{{ rpg_fraction_close_to_mod }}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                            <th colspan="1"><div id="txtInventoryTarget">{% trans "Not Go Over:" %}</div></th>
                            <td colspan="1">{{ rpg_max_purchase }}</td>
                            <td colspan="1">{{ rpg_fraction_close_to_max }}</td>
                            </tr>
                        </tfoot>
                    </table>
                </div> <!-- End card body-->
                <span class="small text-muted" id="txtInventoryNote0">{% trans "Inventory bought over your MAX Purchase" %}</span> 
                ({{ rpg_max_purchase }}) 
                <span class="small text-muted" id="txtInventoryNote1"> {% trans "will cause bankruptcy." %}</span>
            </div> <!-- End card -->

            <div class="card custom-card text-dark bg-light mb-3 shadow">
                <h4 class="card-header custom-card-header">{% trans "Flex Point Send/Receive" %}</h4>
                <div class="card-body">
                    <table class="table table-hover table-striped table-responsive">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col" title="From">{% trans "From Group" %}</th>
                                <th scope="col" title="To">{% trans "To Group" %}</th>
                                <th scope="col" title="Flex Points">{% trans "Flex Points" %}</th>
                                <th scope="col" title="Message">{% trans "Message" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for deal in all_gifts %}
                            <tr>
                                <td>{{ deal.groupDigit }}</td>
                                <td>{{ deal.giftReceiver }}</td>
                                <td>{{ deal.giftAmount }}</td>
                                <td>{{ deal.giftMessage }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div> <!-- End card body-->
                <div class="small text-muted">{% trans "Note: Only messages for the current RPG round are shown." %}</div>                    
            </div> <!-- End card -->

            <div class="card custom-card text-dark bg-light mb-3 shadow">
                <h4 class="card-header">{% trans "Deals Waiting For Counterpart" %}</h4>
                <div class="card-body">
                    <table class="table table-hover table-striped table-responsive">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col" title="Deal Identifier">{% trans "Deal ID" %}</th>
                                <th scope="col" title="Counterpart Group">{% trans "To" %}<br>{% trans "Group" %}</th>
                                <th scope="col" title="Number of Units">{% trans "Units" %}</th>
                                <th scope="col" title="Deal Price">{% trans "Price" %}</th>
                                <th scope="col" title="Quality Level">{% trans "Qual." %}</th>
                                <th scope="col" title="Delivery Speed">{% trans "Deliv." %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for deal in waiting_for_counterpart %}
                            <tr>
                                <td>{{ deal.dealDealID }}</td>
                                <td>{{ deal.dealCounterpart }}</td>
                                <td>{{ deal.dealUnits }}</td>
                                <td>{{ deal.dealPrice }}</td>
                                <td>{{ deal.dealQuality }}</td>
                                <td>{{ deal.dealDelivery }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div> <!-- End card body-->
            </div> <!-- End card -->

            <div class="card custom-card text-dark bg-light mb-3 shadow">
                <h4 class="card-header">{% trans "Deals Waiting For You" %}</h4>
                <div class="card-body">
                    <table class="table table-hover table-striped table-responsive deal-row:hover">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col" title="Deal Identifier">{% trans "Deal ID" %}</th>
                                <th scope="col" title="Counterpart Group">{% trans "From" %}<br>{% trans "Group" %}</th>
                                <th scope="col" title="Number of Units">{% trans "Units" %}</th>
                                <th scope="col" title="Deal Price">{% trans "Price" %}</th>
                                <th scope="col" title="Quality Level">{% trans "Qual." %}</th>
                                <th scope="col" title="Delivery Speed">{% trans "Deliv." %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for deal in waiting_for_you %}
                            <tr class="deal-row" data-dealid="{{ deal.dealDealID }}" data-counterparty="{{ deal.groupDigit }}" data-units="{{ deal.dealUnits }}" data-price="{{ deal.dealPrice }}" data-quality="{{ deal.dealQuality }}" data-delivery="{{ deal.dealDelivery }}">
                                <td><a href="#" class="deal-link" data-dealid="{{ deal.dealDealID }}" data-counterparty="{{ deal.groupDigit }}" data-units="{{ deal.dealUnits }}" data-price="{{ deal.dealPrice }}" data-quality="{{ deal.dealQuality }}" data-delivery="{{ deal.dealDelivery }}">{{ deal.dealDealID }}</a></td>
                                <td>{{ deal.groupDigit }}</td>
                                <td>{{ deal.dealUnits }}</td>
                                <td>{{ deal.dealPrice }}</td>
                                <td>{{ deal.dealQuality }}</td>
                                <td>{{ deal.dealDelivery }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div><!-- End card body-->
            </div> <!-- End card -->

            <div class="card custom-card text-dark bg-light mb-3 shadow">
                <h4 class="custom-card-warn-header">{% trans "Deals Mismatched" %}<sup>a</sup></h4>
                <div class="card-body">
                    <table class="table table-hover table-striped table-responsive">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col" title="Deal Identifier">{% trans "Deal ID" %}</th>
                                <th scope="col" title="From">{% trans "To" %}<br>{% trans "Group" %}</th>
                                <th scope="col" title="To">{% trans "From" %}<br>{% trans "Group" %}</th>
                                <th scope="col" title="Role">{% trans "Role" %}</th>
                                <th scope="col" title="Number of Units">{% trans "Units" %}</th>
                                <th scope="col" title="Deal Price">{% trans "Price" %}</th>
                                <th scope="col" title="Quality Level">{% trans "Qual." %}</th>
                                <th scope="col" title="Delivery Speed">{% trans "Deliv." %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for deal in error_deals %}
                            <tr>
                                <td>{{ deal.dealDealID }}</td>
                                <td>{{ deal.dealCounterpart }}</td>
                                <td>{{ deal.groupDigit }}</td>
                                <td>{{ deal.dealBuySell }}</td>
                                <td>{{ deal.dealUnits }}</td>
                                <td>{{ deal.dealPrice }}</td>
                                <td>{{ deal.dealQuality }}</td>
                                <td>{{ deal.dealDelivery }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div> <!-- End card body-->
                <div class="small text-muted"><sup>a</sup>{% trans "These deals use the same Deal ID but do not match." %}</div>
                <div class="small text-muted">{% trans "Senders need to cancel these." %}</div>
                <div class="small text-muted">{% trans "Note: Role 1 = Buyer; -1 = Seller." %}</div>
            </div> <!-- End card -->

            <div class="card custom-card text-dark bg-light mb-3 shadow">
                <h4 class="card-header custom-card-header">{% trans "RPG Score:" %} {{ rpg_scoreFinal }}</h4>
                <div class="card-body">
                    <table class="table">
                        <thead class="text-secondary">
                            <tr>
                                <th id="txtBuyerScorePriceTop0" scope="col" class="d-none fs-6 py-0 px-0 text-center">{% trans "Resistance" %}<br>{% trans "Price" %}</th>
                                <th id="txtBuyerScorePriceTop1" scope="col" class="d-none fs-6 py-0 px-0 text-center"><i class="fas fa-minus"></i></th>
                                <th id="txtBuyerScorePriceTop2" scope="col" class="d-none fs-6 py-0 px-0 text-center">{% trans "Weighted" %}<br>{% trans "Avg. Price" %}</th>
                                <th id="txtSellerScorePriceTop0" scope="col" class="d-none fs-6 py-0 px-0 text-center">{% trans "Weighted" %}<br>{% trans "Avg. Price" %}</th>
                                <th id="txtSellerScorePriceTop1" scope="col" class="d-none fs-6 py-0 px-0 text-center"><i class="fas fa-minus"></i></th>
                                <th id="txtSellerScorePriceTop2" scope="col" class="d-none fs-6 py-0 px-0 text-center">{% trans "Resistance" %}<br>{% trans "Price" %}</th>
                                <th scope="col" class="fs-6 py-0 px-0 text-center"><i class="fas fa-equals"></i></th>
                                <th scope="col" class="fs-6 py-0 px-0 text-center">__</th>
                                <th scope="col" class="fs-6 py-0 px-0 text-center"><i class="fas fa-divide"></i></th>
                                <th scope="col" class="fs-6 py-0 px-0 text-center">{% trans "Resistance" %}<br>{% trans "Price" %}</th>      
                                <th scope="col" class="fs-6 py-0 px-0 text-center"><i class="fas fa-equals"></i></th>
                                <th scope="col" class="fs-6 py-0 px-0 text-center">__</th>
                                <th scope="col" class="fs-6 py-0 px-0 text-center">X<i class="fw-bolder"></i></th>
                                <th scope="col" class="fs-6 py-0 px-0 text-center">100<i class="fw-bolder"></i></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="text-center fw-bold">
                                <td id="txtBuyerScorePriceData" scope="col" class="d-none fs-6 py-0 px-0 text-center">{{ rpg_resistance }}</td>
                                <td id="txtBuyerScorePriceData" scope="col" class="d-none fs-6 py-0 px-0 text-center"><i class="fas fa-minus"></i></td>
                                <td id="txtBuyerScorePriceData" scope="col" class="d-none fs-6 py-0 px-0 text-center">{{ average_weighted }}</td>
                                <td id="txtSellerScorePriceData" scope="col" class="d-none fs-6 py-0 px-0 text-center">{{ average_weighted }}</td>
                                <td id="txtSellerScorePriceData" scope="col" class="d-none fs-6 py-0 px-0 text-center"><i class="fas fa-minus"></i></td>
                                <td id="txtSellerScorePriceData" scope="col" class="d-none fs-6 py-0 px-0 text-center">{{ rpg_resistance }}</td>
                                <td scope="col" class="fs-6 py-0 px-0 text-center"><i class="fas fa-equals"></i></td>
                                <td scope="col" class="fs-6 py-0 px-0 text-center">{{ rpg_scoreA }}</td>
                                <td scope="col" class="fs-6 py-0 px-0 text-center"><i class="fas fa-divide"></i></td>
                                <td scope="col" class="fs-6 py-0 px-0 text-center">{{ rpg_resistance }}</td>
                                <td scope="col" class="fs-6 py-0 px-0 text-center"><i class="fas fa-equals"></i></td>
                                <td scope="col" class="fs-6 py-0 px-0 text-center">{{ rpg_scoreB }}</td>
                                <td scope="col" class="fs-6 py-0 px-0 text-center">X<i class="fw-bolder"></i></td>
                                <td scope="col" class="fs-6 py-0 px-0 text-center">100<i class="fw-bolder"></i></td>
                            </tr>
                         </tbody>
                         <tfoot>
                            <tr class="fw-bolder fs-3">
                            <th colspan="3"><i class="fas fa-equals"></i> {{ rpg_scoreC }}<i class="fas fa-plus"></i></th>
                            </tr>
                        </tfoot>
                    </table>
    
                    <table class="table">
                        <thead class="text-secondary table-responsive">
                            <tr>
                            <th scope="col" class="fs-6 py-0 px-0 text-center">{% trans "Flex Points" %}</th>
                            <th scope="col" class="fs-6 py-0 px-0 text-center"><i class="fas fa-equals"></i></th>
                            <th scope="col" class="fs-6 py-0 px-0 text-center">__</th>
                            <th scope="col" class="fs-6 py-0 px-0 text-center">X<i class="fw-bolder"></i></th>
                            <th scope="col" class="fs-6 py-0 px-0 text-center">{% trans "Importance" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="text-center fw-bold">
                            <td scope="col" class="fs-6 py-0 px-0 text-center">{{ rpgFlexPoints }}</td>
                            <td scope="col" class="fs-6 py-0 px-0 text-center"><i class="fas fa-equals"></i></td>
                            <td scope="col" class="fs-6 py-0 px-0 text-center">{{ rpg_scoreD }}</td>
                            <td scope="col" class="fs-6 py-0 px-0 text-center">X<i class="fw-bolder"></i></td>
                            <td scope="col" class="fs-6 py-0 px-0 text-center">{{ groupImportance }}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="fw-bolder fs-3">
                            <th colspan="3"><i class="fas fa-equals"></i> {{ rpg_scoreE }} X</th>
                            </tr>
                        </tfoot>
                    </table>
    
                    <table class="table">
                        <thead class="text-secondary table-responsive">
                            <tr>
                            <th id="txtBuyerScoreInventory" scope="col" class="d-none fs-6 py-0 px-0 text-center">{% trans "Inventory Bought" %}</th>
                            <th id="txtSellerScoreInventory" scope="col" class="d-none fs-6 py-0 px-0 text-center">{% trans "Inventory Sold" %}</th>
                            <th scope="col" class="fs-6 py-0 px-0 text-center"><i class="fas fa-equals"></i></th>
                            <th scope="col" class="fs-6 py-0 px-0 text-center">{% trans "Score" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="text-center fw-bold fs-3">
                            <td scope="col" class="fs-6 py-0 px-0 text-center">{{ rpg_fraction_close_to_mod }}</td>
                            <td scope="col" class="fs-6 py-0 px-0 text-center"><i class="fas fa-equals"></i></td>
                            <td scope="col" class="fs-6 py-0 px-0 text-center">{{ rpg_scoreFinal }}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="fw-bolder fs-1">
                            <th colspan="3">{% trans "SCORE:" %} {{ rpg_scoreFinal }}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div> <!-- End card body -->
            </div> <!-- End card -->

            <div class="card custom-card text-dark bg-light mb-3 shadow">
                <h4 class="card-header custom-card-header">{% trans "Messages Received" %}<sup>a</sup></h4>
                <div class="card-body">
                    <table class="table table-hover table-striped table-responsive">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col" title="From">{% trans "From" %}<br>{% trans "Group" %}</th>
                                <th scope="col" title="To">{% trans "To" %}<br>{% trans "Group" %}</th>
                                <th scope="col" title="Subject">{% trans "Subject" %}</th>
                                <th scope="col" title="Message">{% trans "Message" %}</th>
                                <th scope="col" title="Timestamp">{% trans "Date" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for deal in all_messages %}
                            <tr>
                                <td>{{ deal.groupDigit }}</td>
                                <td>{{ deal.messageReceiver }}</td>
                                <td>{{ deal.messageSubject }}</td>
                                <td>{{ deal.messageContent }}</td>
                                <td>{{ deal.messageDateStamp|date:"m/d H:i" }}</td>
                            </tr>
                            {% endfor %}                            
                        </tbody>
                    </table>
                </div> <!-- End card body-->
                <div class="small text-muted"><sup>a</sup>{% trans "Note: Only messages for the current RPG round are shown." %}</div>
            </div><!-- End card -->

            <div class="card custom-card text-dark bg-light mb-3 shadow">

                <form id="selectRPGForm" method="get" action="{% url 'position_buyer_seller_manual' %}">
                    <select name="rpg_choice" id="rpg_choice">
                        <option value="-1" selected>{% trans "Change Round" %}</option>
                        {% for rpg in "0123456789"|make_list %}
                            <option value="{{ rpg }}" {% if rpg == request.GET.rpg_choice %}selected{% endif %}>RPG {{ rpg }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit">Go</button>
                    {% trans "BUYERS:" %} {{ buyers_count }} {% trans "SELLERS:" %} {{ sellers_count }}
                </form>

                <h4 class="card-header custom-card-header">{% trans "Marketplace" %}<sup></sup></h4>
                <div class="card-body">
                    <table class="table table-hover table-striped table-responsive">
                        <thead class="thead-dark">
                            <tr>
                                <th scope="col" title="Group">{% trans "Group" %}</th>
                                <th scope="col" title="Role">{% trans "RPG Role" %}</th>
                                <th scope="col" title="Score">{% trans "Current Score" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in all_groups_results %}
                            <tr>
                                <td>{{ group.group_digit }}</td>
                                <td>{{ group.group_role_name }}</td>
                                <td>{{ group.scoreFinal }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div> <!-- End card body-->
                <div class="small text-muted"><sup></sup></div>                    
            </div> <!-- End card -->

        </div> <!-- End of row with prefer two columns -->
    </div> <!-- End of container -->

<script>
// Loading localizations to be used  in javascript 
var translations = { //create object to hold translations
    averageLabel: "{% trans 'Average' %}",
    averageQualityLabel: "{% trans '[2] Average' %}",
    buyerLabel: "{% trans 'BUYER' %}",
    cannotBuyOver: "{% trans 'You cannot buy over your resistance price.' %}",
    cannotSellBelow: "{% trans 'You cannot sell below your resistance price.' %}",
    counterpartPositive: "{% trans 'Counterpart must be a positive number.' %}",
    dealForFaster: "{% trans ' Try to make a deal for faster.' %}",
    dealForHigher: "{% trans ' Try to make a deal for higher.' %}",
    dealForLower: "{% trans ' Try to make a deal for lower.' %}",
    dealForSlower: "{% trans ' Try to make a deal for slower.' %}",
    deliveryBetween: "{% trans 'Delivery must be between Slow and Fast.' %}",
    distributePointsHere: "{% trans 'Distribute Points Here' %}",
    doNotBuyMoreThanThis: "{% trans ' Do not buy more than this.' %}",
    doNotBuyOver: "{% trans 'Do NOT Buy Over:' %}",
    doNotPayMoreThan: "{% trans ' Do not pay more than this.' %}",
    doNotSellForLess: "{% trans ' Do not sell for less than this.' %}",
    flexPointsDescription: "{% trans ' Spend, collect, or gift these.' %}",
    goingHigherGains: "{% trans 'Going higher gains Flex Points (1 point per 100 units--round up).' %}",
    goingHigherSpends: "{% trans 'Going HIGHER spends Flex Points (1 point per 100 units--round up).' %}",
    goingLowerGains: "{% trans 'Going LOWER gains Flex Points (1 point per 100 units--round up).' %}",
    goingLowerSpends: "{% trans 'Going lower spends Flex Points (1 point per 100 units--round up).' %}",
    highQualityLabel: "{% trans '[3] High' %}",
    howImportant: "{% trans 'How important is this deal.' %}",
    importantLabel: "{% trans 'Important' %}",
    inventoryBought: "{% trans 'Inventory Bought' %}",
    inventoryBoughtOverMax0: "{% trans 'Inventory bought over your MAX Purchase' %}",
    inventoryBoughtOverMax1: "{% trans 'will cause bankruptcy.' %}",
    inventorySold: "{% trans 'Inventory Sold' %}",
    kindOfImportant: "{% trans 'Kind Of Important' %}",
    lowQualityLabel: "{% trans '[1] Low' %}",
    maxSales: "{% trans 'MAX Sales:' %}",
    newDealID: "{% trans 'New Deal ID:' %}",
    noneLabel: "{% trans 'NONE' %}",
    notTimeForDeals0: "{% trans 'Not time for deals yet.' %}",
    notTimeForDeals1: "{% trans 'Deals can begin at ' %}",
    pricePositive: "{% trans 'Price must be a positive number.' %}",
    purchaseOrder: "{% trans 'PURCHASE ORDER' %}",
    qualityBetween: "{% trans 'Quality must be between Low and High.' %}",
    saleInvoice: "{% trans 'SALE INVOICE' %}",
    sellerLabel: "{% trans 'SELLER' %}",
    sellingOverMax: "{% trans 'Selling over MAX will cost Flex Points to increase capacity.' %}",
    sellingOverThis: "{% trans ' Selling over this will cost Flex Points.' %}",
    slowLabel: "{% trans 'Slow' %}",
    smallPotatoes: "{% trans 'Small Potatoes' %}",
    somewhatImportant: "{% trans 'Somewhat Important' %}",
    targetBuyingAtLeast: "{% trans ' Target buying at least this many.' %}",
    targetSellingAtLeast: "{% trans ' Target selling at least this many.' %}",
    targetThis: "{% trans 'Target This:' %}",
    unitsPositive: "{% trans 'Units must be a positive number.' %}",
    veryImportantLabel: "{% trans 'Very Important' %}",
    vitalImportanceLabel: "{% trans 'Vital Importance' %}",
}; // end javacript translations

$(document).ready(function() {
    // Array to hold the IDs of the divs you are toggling
    const divsToToggle = ['btnOpenDealForm', 'btnOpenCancelForm', 'btnOpenSendFlexForm', 'btnOpenSendMessageForm'];
    var currentOpenDiv = null; // keep track of the currently open div
    var timeStampInMilliseconds = 0 //need wide scope for this as it is used later
    //Send Deal Clicked
    $('#btnSendDeal').click(function() {
        toggleDiv('btnOpenDealForm');
        // Generate UNIX timestamp in milliseconds
        timeStampInMilliseconds = new Date().getTime();
        $('#newDealID').text(translations.newDealID + timeStampInMilliseconds);
    });
    $('#btnCancelDeal').click(function() {
        toggleDiv('btnOpenCancelForm');
    });
    $('#btnSendFlex').click(function() {
        toggleDiv('btnOpenSendFlexForm');
    });
    $('#btnSendMessage').click(function() {
        toggleDiv('btnOpenSendMessageForm');
    });

    // Different text for buyer/seller
    if ({{ groupRole }} == -1){ //seller case
        $("#txtInventoryTitle").text(translations.inventorySold);
        $("#txtInventoryTarget").text(translations.targetThis);
        $("#txtInventoryNote0").text(translations.sellingOverMax);
    }else{ //buyer case
        $("#txtInventoryTitle").text(translations.inventoryBought);
        $("#txtInventoryTarget").text(translations.doNotBuyOver);
        $("#txtInventoryNote0").text(translations.inventoryBoughtOverMax0);
        $("#txtInventoryNote1").text(translations.inventoryBoughtOverMax1);
    } //end elseIf

    //setting up time checking for playing RPG----Put here for wide scope used to check submissions allowed or now
    var dealsBegin = new Date({{ rpg_closest_end_date|date:"U" }} * 1000); // Convert to milliseconds
    var dealsEnd = new Date({{ rpg_play_days_left|date:"U" }} * 1000); // Convert to milliseconds
    //setup time
    var now = new Date();
    //FIRST for the END time (check end first then check start)
    var timeDifferenceBegin = dealsBegin - now;
    var timeDifferenceEnd = dealsEnd - now;

    function toggleDiv(divId) {
    // Close all divs first
        for (let id of divsToToggle) {
            if($('#' + id).is(':visible')) {
                // Reset the form inside this div if it has one
                $('#' + id + ' form').each(function(){
                    this.reset();
                });
            }
            $('#' + id).slideUp('slow');
        }

        // If the div being toggled is different from the one already open, open it
        if (currentOpenDiv !== divId) {
            $('#' + divId).slideDown('slow');
            currentOpenDiv = divId; // update the currently open div
        } else {
            currentOpenDiv = null; // reset the currently open div since we're closing it
        }
    }
    
    //fix the Buyer/Seller to text not integer on page when first loading page
    // Also hide/show parts specific to Buyer/Seller
    if ({{ groupRole }} == -1){
        $(".txtRole").text(translations.sellerLabel);
        $("#txtOrderTitle").text(translations.saleInvoice);
        $("#txtFlexMsg0").html("<sup>a</sup>" + translations.goingLowerGains);
        $("#txtFlexMsg1").html(translations.goingHigherSpends);
        $("[id^='txtSellerScore']").removeClass('d-none'); // Buyer RPG calculation Resistance - Price
    }else if({{ groupRole }} == 1){
        $(".txtRole").text(translations.buyerLabel);
        $("#txtOrderTitle").text(translations.purchaseOrder);
        $("#txtFlexMsg0").html("<sup>a</sup>" + translations.goingHigherGains);
        $("#txtFlexMsg1").html(translations.goingLowerSpends);
        $("#txtFlexMsg4").hide();
        $("#txtOverProduction").hide(); // Buyer does not have over production
        $("[id^='txtBuyerScore']").removeClass('d-none'); // Buyer RPG calculation Resistance - Price
    }else{
        $(".txtRole").text(translations.noneLabel);
    }//end elseIf
    
    // Declare variables that need wide scope here
    var groupRole = {{ groupRole }}; //use this variable across functions; Load on page load but remember to change as needed
    var groupDiceLastRoll = {{ groupDiceLastRoll }}; //use this variable across functions;

    //Set the descriptions for Quick View for BUYER case
    var meaning = 0; //holder for description of position post live calculation

    //Delivery
    var attributeValue = {{ groupDelivery }};
    var attributeValueText = "";
        switch (attributeValue) {
            case 0:
            case 1:
                attributeValueText = translations.slowLabel;
                break;
            case 2:
                attributeValueText = translations.averageLabel;
                break;
            case 3:
                attributeValueText = "Fast";
                break;
        } //end switch selectedValue
    //add text to attribute
    $("#txtPositionDelivery").text("[{{ groupDelivery }}] " + attributeValueText);
    // Different text for buyer/seller
    if ({{ groupRole }} == -1){
        $("#txtPositionDeliveryHelp").text(translations.dealForSlower);
        //Resistance
        $("#txtPositionResistanceHelp").text(translations.doNotSellForLess);
        //Mod Units
        $("#txtPositionUnitsHelp").text(translations.targetSellingAtLeast);
        //MAX Purchase
        $("#txtPositionMaxPurchaseHelp").text(translations.sellingOverThis);
        $("#txtMaxPurchase").text(translations.maxSales);
    }else{
        $("#txtPositionDeliveryHelp").text(translations.dealForFaster);
        //Resistance
        $("#txtPositionResistanceHelp").text(translations.doNotPayMoreThan);
        //Mod Units
        $("#txtPositionUnitsHelp").text(translations.targetBuyingAtLeast);
        //MAX Purchase
        $("#txtPositionMaxPurchaseHelp").text(translations.doNotBuyMoreThanThis);
    }//end elseIf

    //Flex
    $("#txtPositionFlexHelp").text(translations.flexPointsDescription);

    //Importance
    attributeValueText = "";
    var attributeValue = {{ groupImportance }};
        switch (attributeValue) {
            case 0:
                attributeValueText = translations.distributePointsHere;
                break;
            case 1:
                attributeValueText = translations.smallPotatoes;
                break;
            case 2:
                attributeValueText = translations.kindOfImportant;
                break;
            case 3:
                attributeValueText = translations.somewhatImportant;
                break;
            case 4:
                attributeValueText = translations.importantLabel;
                break;
            case 5:
                attributeValueText = translations.veryImportantLabel;
                break;
            case 6:
                attributeValueText = translations.vitalImportanceLabel;
                break;
        } //end switch selectedValue
    //add text to attribute
    $("#txtPositionImportance").text("[{{ groupImportance }}] " + attributeValueText);
    $("#txtPositionImportanceHelp").text(translations.howImportant);

    //Quality
    attributeValueText = "";
    var attributeValue = {{ groupQuality }};
        switch (attributeValue) {
            case 0:
            case 1:
                attributeValueText = translations.lowQualityLabel;
                break;
            case 2:
                attributeValueText = translations.averageQualityLabel;
                break;
            case 3:
                attributeValueText = translations.highQualityLabel;
                break;
        } //end switch selectedValue
    //add text to attribute
    $("#txtPositionQuality").text(attributeValueText);

    // Different text for buyer/seller
    if ({{ groupRole }} == -1){ //seller case
        $("#txtPositionQualityHelp").text(translations.dealForLower);
    }else{ //buyer case
        $("#txtPositionQualityHelp").text(translations.dealForHigher);
    }//end elseIf

    // When btnSubmitDeal is clicked, the form inputs are checked
    $("#btnSubmitDeal").click(function(event){
        var isValid = true; // Initialize flag
        var errorMessage = ''; // Initialize error message

        if(timeDifferenceBegin < 0 && timeDifferenceEnd > 0) { //time for roll is OVER OR PlayNow has already been used
            var isValid = true; // Set flag as pass
        }else{ //NOT time now
            var isValid = false; // Set flag as fail
            errorMessage = translations.notTimeForDeals0 + "\n" + translations.notTimeForDeals1 + dealsBegin + ".";
            event.preventDefault(); // Prevent form submission
        }

        // Validate counter_part_group_number
        var counterPart = $("input[name='counterparty']").val();
        if(counterPart === "" || counterPart <= 0) {
            isValid = false;
            errorMessage += "Counterpart must be a positive number.\n";
        }
        // Validate number_of_units
        var units = $("input[name='units']").val();
        if(units === "" || units <= 0) {
            isValid = false;
            errorMessage += translations.unitsPositive + "\n";
        }
        // Validate price
        var price = $("input[name='price']").val();
        if(price === "" || price <= 0) {
            isValid = false;
            errorMessage += translations.pricePositive + "\n";
        }
        if ({{ groupRole }} == -1){ // Seller case
            if(price < {{ rpg_resistance }}) {
                isValid = false;
                errorMessage += translations.cannotSellBelow + "\n";
            }
        }else{
            if(price > {{ rpg_resistance }}) {
                isValid = false;
                errorMessage += translations.cannotBuyOver + "\n";
            }
        }
        // Validate quality
        var quality = $("select[name='quality']").val();
        if(quality < 1 || quality > 3) {
            isValid = false;
            errorMessage += translations.qualityBetween + "\n";
        }
        // Validate delivery
        var delivery = $("select[name='delivery']").val();
        if(delivery < 1 || delivery > 3) {
            isValid = false;
            errorMessage += translations.deliveryBetween + '\n';
        }
        // Validate Deal ID
        var dealID = $("input[name='dealID']").val();
        if(dealID.length < 13) {
            isValid = false;
            errorMessage += 'Deal ID must be at least 13 digits long.\n';
        }        
        if(!isValid) {
            event.preventDefault(); // Prevent form submission
            alert("Form validation failed:\n" + errorMessage);
        }
    }); // End click button function

    // When btnCancelDeal is clicked, the form inputs are checked
    $("#btnSubmitCancel").click(function(event){
        var isValid = true; // Initialize flag
        var errorMessage = ''; // Initialize error message
        // Validate counter_part_group_number
        var counterPart = $("input[name='counterpartyCancel']").val();
        if(counterPart === "" || counterPart <= 0) {
            isValid = false;
            errorMessage += translations.counterpartPositive + "\n";
        }
        // Validate Deal ID
        var dealID = $("input[name='dealIDCancel']").val();
        if(dealID.length < 13) {
            isValid = false;
            errorMessage += 'Deal ID must be at least 13 digits long.\n';
        }        
        if(!isValid) {
            event.preventDefault(); // Prevent form submission
            alert("Form validation failed:\n" + errorMessage);
        }
    }); // End click button function
    
    // User chooses to input the NEW Deal ID with a single click
    $("#txtUseThisID").click(function(e) {
        e.preventDefault();  // Prevent the default link behavior
        var dealID = $("#newDealID").text();  // Get the Deal ID
        $("#inputDealID").val(timeStampInMilliseconds);
    });

    $('.deal-link').on('click', function(e) {
    e.preventDefault();  // To prevent the default behavior of the hyperlink

    let dealID = $(this).data('dealid');
    let counterparty = $(this).data('counterparty');
    let units = $(this).data('units');
    let price = $(this).data('price');
    let quality = $(this).data('quality');
    let delivery = $(this).data('delivery');

    // Populate the form fields
    $('input[name="dealID"]').val(dealID);
    $('input[name="counterparty"]').val(counterparty);
    $('input[name="units"]').val(units);
    $('input[name="price"]').val(price);
    $('select[name="quality"]').val(quality);
    $('select[name="delivery"]').val(delivery);

    // Show the form if it's hidden
    $('#btnOpenDealForm').show();
});


    // User clicks on Deals Waiting For You to prepopulate the Send A Deal form (saves copying and making errors)
    $('.deal-link').on('click', function(e) {
    e.preventDefault();  // To prevent the default behavior of the hyperlink
        // Fetch data attributes from the clicked row
        let dealID = $(this).data('dealid');
        let counterparty = $(this).data('counterparty');
        let units = $(this).data('units');
        let price = $(this).data('price');
        let quality = $(this).data('quality');
        let delivery = $(this).data('delivery');

        // Populate form fields with these values
        $("#inputCounterparty").val(counterparty);
        $("#inputUnits").val(units);
        $("#inputPrice").val(price);
        $("select[name='quality']").val(quality);
        $("select[name='delivery']").val(delivery);
        $("#inputDealID").val(dealID);
        
        // Optionally, show the form if it's hidden
        $('#btnOpenDealForm').show();
        // Smoothly scroll to the top
        $('html, body').animate({ scrollTop: 0 }, 'slow');
    });


    //Rotate anime graphics once on page load
    let randomIndex = Math.floor(Math.random() * 11); // Random number between 0 and 19
    let filename = "deals_animeStyle_" + String(randomIndex).padStart(2, '0') + ".jpg";
    document.getElementById("imgRandomImage").src = "{% static 'images/' %}" + filename;


});//document ready

</script>

</body>
</html>
